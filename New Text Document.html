<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysian Resort - Loyalty Program</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* General styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            border-radius: 20px; /* Rounded corners for the main container */
            background: rgba(255,255,255,0.95);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #333; /* Changed header color for better contrast on white background */
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            color: #667eea; /* Color for the main heading */
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.8;
            color: #555;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-tab {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Gradient background */
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px; /* Rounded corners */
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .nav-tab:hover, .nav-tab.active {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); /* Inverted gradient on hover/active */
        }

        /* Tab content */
        .tab-content {
            display: none;
            padding: 30px;
            border-radius: 20px;
            background: white; /* White background for tab content */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px; /* Rounded corners */
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102,126,234,0.3);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        /* Customer card */
        .customer-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .customer-card h3 {
            color: #8b4513;
            margin-bottom: 10px;
        }

        .points-display {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            text-align: center;
            margin: 20px 0;
        }

        /* Facilities grid */
        .facilities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .facility-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .facility-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .facility-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        /* Rewards grid */
        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .reward-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .reward-card h4 {
            color: #8b4513;
            margin-bottom: 10px;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-weight: bold;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Table styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px; /* Rounded corners for table */
            overflow: hidden; /* Ensures rounded corners apply to content */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #555;
        }

        .table tbody tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content .modal-buttons {
            margin-top: 20px;
        }

        .modal-content .modal-buttons .btn {
            margin: 0 10px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-tab {
                width: 200px;
                text-align: center;
            }
            
            .facilities {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèñÔ∏è Elysian Resort</h1>
            <p>Loyalty Program Management System</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('customer', this)">Customer Registration</button>
            <button class="nav-tab" onclick="showTab('lookup', this)">Customer Lookup</button>
            <button class="nav-tab" onclick="showTab('points', this)">Add Points</button>
            <button class="nav-tab" onclick="showTab('redeem', this)">Redeem Points</button>
            <button class="nav-tab" onclick="showTab('staff', this)">Staff Dashboard</button>
            <button class="nav-tab" onclick="showTab('rewards', this)">Rewards Program</button>
        </div>

        <div id="customer" class="tab-content active">
            <h2>Customer Registration</h2>
            <div class="alert success" id="registrationAlert"></div>
            
            <form id="registrationForm">
                <div class="form-group">
                    <label for="customerName">Full Name *</label>
                    <input type="text" id="customerName" required>
                </div>
                
                <div class="form-group">
                    <label for="customerPhone">Phone Number *</label>
                    <input type="tel" id="customerPhone" required placeholder="0712345678">
                </div>
                
                <div class="form-group">
                    <label for="customerEmail">Email Address</label>
                    <input type="email" id="customerEmail" placeholder="customer@email.com">
                </div>
                
                <div class="form-group">
                    <label for="customerID">ID Number</label>
                    <input type="text" id="customerID" placeholder="12345678">
                </div>
                
                <button type="submit" class="btn">Register Customer</button>
            </form>
        </div>

        <div id="lookup" class="tab-content">
            <h2>Customer Lookup</h2>
            <div class="alert" id="lookupAlert"></div>
            
            <div class="form-group">
                <label for="searchPhone">Search by Phone Number</label>
                <input type="tel" id="searchPhone" placeholder="Enter phone number" class="search-box">
            </div>
            
            <button onclick="lookupCustomer()" class="btn">Search Customer</button>
            
            <div id="customerDetails" style="display: none;">
                <div class="customer-card">
                    <h3 id="detailName"></h3>
                    <p><strong>Phone:</strong> <span id="detailPhone"></span></p>
                    <p><strong>Email:</strong> <span id="detailEmail"></span></p>
                    <p><strong>Member Since:</strong> <span id="detailDate"></span></p>
                    <div class="points-display">
                        <span id="detailPoints"></span> Points
                    </div>
                    <div id="expiringPointsInfo" class="alert info" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div id="points" class="tab-content">
            <h2>Add Points</h2>
            <div class="alert" id="pointsAlert"></div>
            
            <div class="facilities">
                <div class="facility-card">
                    <h3>üèä Swimming Pool</h3>
                    <div class="form-group">
                        <input type="tel" id="poolPhone" placeholder="Customer Phone">
                    </div>
                     <div class="form-group">
                        <input type="text" id="poolCheque" placeholder="Cheque/Receipt No.">
                    </div>
                    <div class="form-group">
                        <input type="number" id="poolAmount" placeholder="Amount (KSH)" min="0">
                    </div>
                    <button onclick="addPoints('pool')" class="btn">Add Points</button>
                </div>
                
                <div class="facility-card">
                    <h3>üçΩÔ∏è Restaurant</h3>
                    <div class="form-group">
                        <input type="tel" id="restaurantPhone" placeholder="Customer Phone">
                    </div>
                    <div class="form-group">
                        <input type="text" id="restaurantCheque" placeholder="Cheque/Receipt No.">
                    </div>
                    <div class="form-group">
                        <input type="number" id="restaurantAmount" placeholder="Amount (KSH)" min="0">
                    </div>
                    <button onclick="addPoints('restaurant')" class="btn">Add Points</button>
                </div>
                
                <div class="facility-card">
                    <h3>üçª Bar</h3>
                    <div class="form-group">
                        <input type="tel" id="barPhone" placeholder="Customer Phone">
                    </div>
                    <div class="form-group">
                        <input type="text" id="barCheque" placeholder="Cheque/Receipt No.">
                    </div>
                    <div class="form-group">
                        <input type="number" id="barAmount" placeholder="Amount (KSH)" min="0">
                    </div>
                    <button onclick="addPoints('bar')" class="btn">Add Points</button>
                </div>
                
                <div class="facility-card">
                    <h3>üé† Kids Park</h3>
                    <div class="form-group">
                        <input type="tel" id="kidsPhone" placeholder="Customer Phone">
                    </div>
                     <div class="form-group">
                        <input type="text" id="kidsCheque" placeholder="Cheque/Receipt No.">
                    </div>
                    <div class="form-group">
                        <input type="number" id="kidsAmount" placeholder="Amount (KSH)" min="0">
                    </div>
                    <button onclick="addPoints('kids')" class="btn">Add Points</button>
                </div>
            </div>
        </div>

        <div id="redeem" class="tab-content">
            <h2>Redeem Points</h2>
            <div class="alert" id="redeemAlert"></div>
            
            <div class="form-group">
                <label for="redeemPhone">Search Customer by Phone Number</label>
                <input type="tel" id="redeemPhone" placeholder="Enter phone number" class="search-box">
            </div>
            
            <button onclick="searchCustomerForRedemption()" class="btn">Search Customer</button>
            
            <div id="redeemCustomerDetails" style="display: none;">
                <div class="customer-card">
                    <h3 id="redeemDetailName"></h3>
                    <p><strong>Current Points:</strong> <span id="redeemDetailPoints">0</span></p>
                    <div id="redeemExpiringPointsInfo" class="alert info" style="display: none;"></div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="pointsToRedeem">Points to Redeem</label>
                        <input type="number" id="pointsToRedeem" placeholder="Enter points to redeem" min="1">
                    </div>
                    <div class="form-group">
                        <label for="redemptionReason">Reason for Redemption</label>
                        <input type="text" id="redemptionReason" placeholder="e.g., 10% discount, Free meal">
                    </div>
                    <button onclick="redeemPoints()" class="btn btn-secondary">Redeem Points</button>
                </div>
            </div>
        </div>

        <div id="staff" class="tab-content">
            <h2>Staff Dashboard</h2>
            
            <div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
                <div class="customer-card" style="flex: 1; min-width: 200px;">
                    <h3>Total Customers</h3>
                    <div class="points-display" id="totalCustomers">0</div>
                </div>
                <div class="customer-card" style="flex: 1; min-width: 200px;">
                    <h3>Points Issued Today</h3>
                    <div class="points-display" id="todayPoints">0</div>
                </div>
                <div class="customer-card" style="flex: 1; min-width: 200px;">
                    <h3>Revenue Today (from point-earning transactions)</h3>
                    <div class="points-display">KSH <span id="todayRevenue">0</span></div>
                </div>
            </div>

            <h3>Recent Transactions</h3>
            <table class="table" id="transactionTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Customer</th>
                        <th>Type</th>
                        <th>Cheque No.</th>
                        <th>Details</th>
                        <th>Amount/Points</th>
                    </tr>
                </thead>
                <tbody id="transactionBody">
                </tbody>
            </table>
            
            <div style="margin-top: 30px;">
                <button onclick="exportData()" class="btn">Export Customer Data</button>
                <button onclick="showConfirm('clearAllDataConfirm', 'Are you sure you want to clear all customer data? This cannot be undone.', clearAllData)" class="btn-secondary btn">Clear All Data</button>
            </div>
        </div>

        <div id="rewards" class="tab-content">
            <h2>Rewards Program</h2>
            <p>Earn 1 point for every 1,000 KSH spent across all facilities!</p>
            
            <div class="rewards-grid">
                <div class="reward-card">
                    <h4>50 Points</h4>
                    <p>10% discount on next visit</p>
                </div>
                
                <div class="reward-card">
                    <h4>100 Points</h4>
                    <p>Free Kids Park entry</p>
                </div>
                
                <div class="reward-card">
                    <h4>200 Points</h4>
                    <p>Free meal at restaurant</p>
                </div>
                
                <div class="reward-card">
                    <h4>300 Points</h4>
                    <p>Free swimming pool day pass</p>
                </div>
                
                <div class="reward-card">
                    <h4>500 Points</h4>
                    <p>VIP Member Status</p>
                </div>
                
                <div class="reward-card">
                    <h4>1000 Points</h4>
                    <p>Free weekend stay</p>
                </div>
            </div>
        </div>
    </div>

    <div id="customModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="btn" style="display:none;">Confirm</button>
                <button id="modalCloseBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api'; // Your backend API URL

        // --- Custom Modal Functions ---
        let confirmCallback = null;
        function showAlertModal(title, message) { /* ... (no changes to modal logic itself) ... */ }
        function showConfirm(id, message, callback) { /* ... (no changes to modal logic itself) ... */ }
        function hideModal() { /* ... (no changes to modal logic itself) ... */ }

        /**
         * Loads initial data by fetching from the backend.
         */
        async function loadInitialData() {
            // This function would now fetch initial data needed, e.g., dashboard stats
            // For simplicity, we'll focus on function modifications for now.
            // Example:
            // await updateDashboard(); // Fetch dashboard data on load
            // await checkAllPointsExpiration(); // Trigger server-side check or fetch affected data
            console.log("loadInitialData: Called. In a full SQL setup, this would fetch from backend.");
            // No more localStorage loading here.
            // Initial dashboard update will fetch its own data.
             if (document.getElementById('staff').classList.contains('active')) {
                updateDashboard();
            }
        }
        
        /**
         * Calculates the expiration date for points (3 months from earned date).
         */
        function calculateExpirationDate(dateEarned) {
            const expirationDate = new Date(dateEarned);
            expirationDate.setMonth(expirationDate.getMonth() + 3);
            return expirationDate;
        }

        /**
         * NOTE: Point expiration ideally should be handled by the backend (e.g., a scheduled job or during lookups).
         * This frontend function would now likely trigger a backend process or rely on the backend to manage it.
         */
        async function checkAllPointsExpiration() {
            console.log("checkAllPointsExpiration: This should ideally be a backend process.");
            try {
                // Example: const response = await fetch(`${API_BASE_URL}/points/check-expirations`, { method: 'POST' });
                // if (!response.ok) throw new Error('Failed to trigger point expiration check');
                // const result = await response.json();
                // showAlertModal('Point Expiration', result.message || 'Expiration check initiated.');
                // updateDashboard(); // Refresh dashboard data
            } catch (error) {
                console.error("Error during point expiration check:", error);
                // showAlertModal('Error', 'Could not process point expirations: ' + error.message);
            }
        }


        async function checkCustomerPointsExpiration(customerPhone) {
            console.log(`checkCustomerPointsExpiration for ${customerPhone}: This logic is now mainly on the backend during customer lookup or operations.`);
            // The backend should return up-to-date point info, including any recent expirations.
            // The frontend might display messages about expiring points if the backend API provides that info.
            // For example, the /customers/:phone endpoint could return { ..., points: X, expiringSoon: Y }
        }


        function showTab(tabName, clickedButton) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            clickedButton.classList.add('active');
            
            if (tabName === 'staff') {
                updateDashboard();
            }
            const allAlerts = document.querySelectorAll('.alert');
            allAlerts.forEach(alert => alert.style.display = 'none');
        }

        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const customerData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value,
                idNumber: document.getElementById('customerID').value
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/customers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerData)
                });
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to register customer.');
                }
                
                document.getElementById('registrationForm').reset();
                showAlert('registrationAlert', `Customer ${result.customer.name} registered successfully! Loyalty number: ${result.customer.phone}`, 'success');
                updateDashboard(); // Refresh dashboard if it's relevant
            } catch (error) {
                console.error("Registration error:", error);
                showAlert('registrationAlert', error.message, 'error');
            }
        });

        async function lookupCustomer() {
            const phone = document.getElementById('searchPhone').value;
            const customerDetailsDiv = document.getElementById('customerDetails');
            const expiringPointsInfoDiv = document.getElementById('expiringPointsInfo');
            
            if (!phone) {
                showAlert('lookupAlert', 'Please enter a phone number.', 'info');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/customers/${phone}`);
                if (response.status === 404) {
                    customerDetailsDiv.style.display = 'none';
                    showAlert('lookupAlert', 'Customer not found. Please check the phone number.', 'error');
                    return;
                }
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to fetch customer details.');
                }
                
                const customer = await response.json();
                
                document.getElementById('detailName').textContent = customer.name;
                document.getElementById('detailPhone').textContent = customer.phone;
                document.getElementById('detailEmail').textContent = customer.email || 'Not provided';
                document.getElementById('detailDate').textContent = new Date(customer.datejoined).toLocaleDateString();
                document.getElementById('detailPoints').textContent = customer.points;
                
                // Backend should provide info on points expiring soon
                if (customer.expiringSoon && customer.expiringSoon.total > 0) {
                    expiringPointsInfoDiv.textContent = `${customer.expiringSoon.total} points will expire by ${new Date(customer.expiringSoon.nextExpiryDate).toLocaleDateString()}!`;
                    expiringPointsInfoDiv.style.display = 'block';
                } else {
                    expiringPointsInfoDiv.style.display = 'none';
                }

                customerDetailsDiv.style.display = 'block';
                showAlert('lookupAlert', 'Customer found!', 'success');
            } catch (error) {
                console.error("Lookup error:", error);
                customerDetailsDiv.style.display = 'none';
                showAlert('lookupAlert', error.message, 'error');
            }
        }

        async function addPoints(facility) {
            const phoneInput = document.getElementById(facility + 'Phone');
            const amountInput = document.getElementById(facility + 'Amount');
            const chequeInput = document.getElementById(facility + 'Cheque'); // New cheque input
            
            const pointsData = {
                phone: phoneInput.value,
                amount: parseFloat(amountInput.value),
                facility: facility.charAt(0).toUpperCase() + facility.slice(1),
                chequeNumber: chequeInput.value // Include cheque number
            };
            
            if (!pointsData.phone || isNaN(pointsData.amount) || pointsData.amount <= 0 || !pointsData.chequeNumber) {
                showAlert('pointsAlert', 'Please enter phone, a valid positive amount, and cheque/receipt number.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/points/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pointsData)
                });
                const result = await response.json();

                if (!response.ok) {
                     throw new Error(result.error || 'Failed to add points.');
                }
                
                phoneInput.value = '';
                amountInput.value = '';
                chequeInput.value = ''; // Clear cheque input
                
                showAlert('pointsAlert', `${result.pointsAdded} points added to ${result.customerName}. Total points: ${result.newTotalPoints}`, 'success');
                
                if(result.customerEmail) { // Check if email exists before attempting to send
                    sendEmail(result.customerEmail, 'Points Earned - Elysian Resort Loyalty Program',
                        `Dear ${result.customerName},<br><br>Congratulations! You have earned ${result.pointsAdded} loyalty points for your recent transaction (Receipt: ${pointsData.chequeNumber}) at Elysian Resort.<br><br>Your new total points: ${result.newTotalPoints}.<br><br>These points will expire on ${new Date(result.expirationDate).toLocaleDateString()}.<br><br>Thank you for being a valued member of Elysian Resort Loyalty Program.`);
                }
                updateDashboard();
            } catch (error) {
                console.error("Add points error:", error);
                showAlert('pointsAlert', error.message, 'error');
            }
        }

        async function searchCustomerForRedemption() {
            const phone = document.getElementById('redeemPhone').value;
            const redeemCustomerDetailsDiv = document.getElementById('redeemCustomerDetails');
            const redeemExpiringPointsInfoDiv = document.getElementById('redeemExpiringPointsInfo');

            if (!phone) {
                showAlert('redeemAlert', 'Please enter a phone number.', 'info');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/customers/${phone}`); // Re-use customer lookup
                 if (response.status === 404) {
                    redeemCustomerDetailsDiv.style.display = 'none';
                    showAlert('redeemAlert', 'Customer not found.', 'error');
                    return;
                }
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to fetch customer for redemption.');
                }
                
                const customer = await response.json();
                
                document.getElementById('redeemDetailName').textContent = customer.name;
                document.getElementById('redeemDetailPoints').textContent = customer.points;

                if (customer.expiringSoon && customer.expiringSoon.total > 0) {
                    redeemExpiringPointsInfoDiv.textContent = `${customer.expiringSoon.total} points will expire by ${new Date(customer.expiringSoon.nextExpiryDate).toLocaleDateString()}!`;
                    redeemExpiringPointsInfoDiv.style.display = 'block';
                } else {
                    redeemExpiringPointsInfoDiv.style.display = 'none';
                }

                redeemCustomerDetailsDiv.style.display = 'block';
                showAlert('redeemAlert', 'Customer found! Ready to redeem points.', 'success');
            } catch (error) {
                console.error("Search for redemption error:", error);
                redeemCustomerDetailsDiv.style.display = 'none';
                showAlert('redeemAlert', error.message, 'error');
            }
        }

        async function redeemPoints() {
            const redeemData = {
                phone: document.getElementById('redeemPhone').value,
                pointsToRedeem: parseInt(document.getElementById('pointsToRedeem').value),
                redemptionReason: document.getElementById('redemptionReason').value
            };

            if (!redeemData.phone || isNaN(redeemData.pointsToRedeem) || redeemData.pointsToRedeem <= 0) {
                showAlert('redeemAlert', 'Please enter phone and a positive number of points.', 'error');
                return;
            }
            if (!redeemData.redemptionReason) {
                showAlert('redeemAlert', 'Please provide a reason for redemption.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/points/redeem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(redeemData)
                });
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to redeem points.');
                }
                
                document.getElementById('redeemDetailPoints').textContent = result.newTotalPoints;
                document.getElementById('pointsToRedeem').value = '';
                document.getElementById('redemptionReason').value = '';
                showAlert('redeemAlert', `${result.pointsRedeemed} points redeemed successfully for ${result.customerName}! Remaining points: ${result.newTotalPoints}`, 'success');
                
                if(result.customerEmail){
                    sendEmail(result.customerEmail, 'Points Redeemed - Elysian Resort Loyalty Program',
                        `Dear ${result.customerName},<br><br>Your ${result.pointsRedeemed} loyalty points have been successfully redeemed for "${redeemData.redemptionReason}".<br><br>Your new total points: ${result.newTotalPoints}.<br><br>Thank you for being a valued member of Elysian Resort Loyalty Program.`);
                }
                updateDashboard();
            } catch (error) {
                console.error("Redeem points error:", error);
                showAlert('redeemAlert', error.message, 'error');
            }
        }

        async function updateDashboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/dashboard-stats`);
                if (!response.ok) throw new Error('Failed to fetch dashboard stats.');
                const stats = await response.json();

                document.getElementById('totalCustomers').textContent = stats.totalCustomers;
                document.getElementById('todayPoints').textContent = stats.todayPointsIssued;
                document.getElementById('todayRevenue').textContent = stats.todayRevenue.toLocaleString();
                
                const tbody = document.getElementById('transactionBody');
                tbody.innerHTML = '';
                stats.recentTransactions.forEach(transaction => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(transaction.timestamp).toLocaleString()}</td>
                        <td>${transaction.customername || transaction.customerphone}</td>
                        <td>${transaction.transactiontype}</td>
                        <td>${transaction.chequenumber || 'N/A'}</td>
                        <td>${transaction.details}</td>
                        <td>${transaction.amountorpoints}</td>
                    `;
                });
            } catch (error) {
                console.error("Dashboard update error:", error);
                showAlertModal('Dashboard Error', 'Could not load dashboard data: ' + error.message);
            }
        }

        function showAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        async function exportData() {
            try {
                // This will now hit a backend endpoint that generates and sends the file
                window.location.href = `${API_BASE_URL}/export-data`; // Triggers download
                showAlertModal('Data Export', 'Data export initiated. Your download should begin shortly.');
            } catch (error) {
                console.error("Export error:", error);
                showAlertModal('Export Error', 'Could not export data: ' + error.message);
            }
        }
        
        async function clearAllData() {
             try {
                const response = await fetch(`${API_BASE_URL}/clear-all-data`, { method: 'DELETE' });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to clear data.');
                }
                const result = await response.json();
                showAlertModal('Data Cleared', result.message || 'All data cleared successfully.');
                updateDashboard(); // Refresh views
            } catch (error) {
                console.error("Clear data error:", error);
                showAlertModal('Error Clearing Data', error.message);
            }
        }

        async function sendEmail(toEmail, subject, htmlContent) {
             if (!toEmail) {
                console.warn("Recipient email is missing. Email not sent for subject:", subject);
                // showAlertModal('Email Info', 'Recipient email address is missing for this customer. Email not sent.');
                return; // Silently fail if no email, or handle as preferred
            }
            try {
                const response = await fetch('http://localhost:3000/send-email', { // Assuming email server is separate
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ toEmail, subject, htmlContent })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`Failed to send email via backend for ${toEmail}:`, response.status, errorData);
                    // Don't show modal for every email, just log it. User action modals are more important.
                    // showAlertModal('Email Failed', `Failed to send email to ${toEmail}. Backend Status: ${response.status}.`);
                } else {
                     console.log(`Email request sent to backend successfully for ${toEmail}`);
                }
            } catch (error) {
                console.error(`Error connecting to email backend for ${toEmail}:`, error);
                // showAlertModal('Email Error', `Could not connect to email service. Error: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', loadInitialData);
    </script>
</body>
</html>